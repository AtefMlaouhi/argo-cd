kind: ConfigMap
apiVersion: v1
metadata:
  name: {{ include "quantalys.policy.act.frontend.shell.fullname" . }}-config
data:
  nginx.conf: |
    {{- tpl .Values.nginx_config . | nindent 4 }}

  config.js: |
    var ActsShellConfig = {
        baseUrl: 'https://{{ .Values.hosts | first }}', // baseUrl utilisée pour charger les assets dans les templates
        keycloakConfig: {
            url: 'https://{{ .Values.config.keycloak.url }}/auth',
            logoutRedirectUrl: 'https://{{ .Values.hosts | first }}', // peut être différente de l'application elle-même
            realm: '{{ .Values.config.keycloak.realm }}',
            clientId: '{{ .Values.config.keycloak.client_id }}',
            loginOptions: {
                idpHint: '',
            },
        },
        microfrontends: [
          {{- range $micro_frontend := .Values.config.micro_frontends }}
          '{{ $micro_frontend.name }}',
          {{- end }}
        ],
        urls: {
            remotes: {
                {{- range $micro_frontend := .Values.config.micro_frontends }}
                {{ $micro_frontend.name }}: 'https://{{ $micro_frontend.host }}/remoteEntry.js',
                {{- end }}
            },
            configs: {
                {{- range $micro_frontend := .Values.config.micro_frontends }}
                {{ $micro_frontend.name }}: 'https://{{ $micro_frontend.host }}/assets/config/config.js',
                {{- end }}
            },
            fonts: {
                {{- range $micro_frontend := .Values.config.micro_frontends }}
                {{ $micro_frontend.name }}: 'https://{{ $micro_frontend.host }}/assets/basalte/fonts.css',
                {{- end }}
            },
        },
        version: '{{ .Values.image.tag }}'
      };

      // pour Angular
      if (typeof window !== 'undefined') {
          window.ActsShellConfig = ActsShellConfig;

          // chargement des configs des microfrontends consommés
          var configs = ActsShellConfig.urls.configs;
          Object.keys(configs).forEach(function (key) {
              var script = document.createElement('script');
              script.src = configs[key];
              document.head.appendChild(script);
          });

          var fonts = ActsShellConfig.urls.fonts;
          Object.keys(fonts).forEach(function (key) {
              var link = document.createElement('link');
              link.rel = 'stylesheet';
              link.type = 'text/css';
              link.href = fonts[key];
              link.media = 'all';
              document.head.appendChild(link);
          });
      }

      // pour Webpack
      if (typeof exports !== 'undefined') {
          exports.ActsShellConfig = ActsShellConfig;
      }

