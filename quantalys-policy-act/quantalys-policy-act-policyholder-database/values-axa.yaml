postgresql:
  image:
    tag: 14.4.0-debian-11-r23
  primary:
    service:
      type: NodePort
    initdb:
      scripts:
        00.sql: |
          CREATE DATABASE policy_act_policyholders;

          -- CI
          CREATE ROLE "policy_act_policyholder_reader" WITH
            LOGIN
            NOSUPERUSER
            NOCREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD '1tiVMz1C';
          CREATE ROLE "svc_policy_act_policyholder" WITH
            LOGIN
            NOSUPERUSER
            NOCREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'DmS9Laqg';
          CREATE ROLE "svc_policy_act_policyholder_ci" WITH
            LOGIN
            NOSUPERUSER
            CREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'nWqgBOSj';
        01.sql: |
          \connect policy_act_policyholders
          -- Create Schema
          CREATE SCHEMA IF NOT EXISTS axa;
          -- Default grants
          REVOKE CONNECT ON DATABASE policy_act_policyholders FROM PUBLIC;
          REVOKE ALL ON ALL TABLES IN SCHEMA public FROM PUBLIC;
          GRANT ALL ON DATABASE policy_act_policyholders TO postgres;
          -- PolicyHolder reader account
          GRANT CONNECT ON DATABASE policy_act_policyholders TO "policy_act_policyholder_reader";
          GRANT USAGE ON SCHEMA axa TO "policy_act_policyholder_reader";
          GRANT SELECT ON ALL TABLES IN SCHEMA axa TO "policy_act_policyholder_reader";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT ON TABLES TO "policy_act_policyholder_reader";
          GRANT CONNECT ON DATABASE policy_act_policyholders TO "svc_policy_act_policyholder";
          -- PolicyHolder service account
          GRANT USAGE ON SCHEMA axa TO "svc_policy_act_policyholder";
          GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA axa TO "svc_policy_act_policyholder";
          GRANT USAGE,SELECT ON ALL SEQUENCES IN SCHEMA axa to "svc_policy_act_policyholder";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO "svc_policy_act_policyholder";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT ON TABLES TO "policy_act_policyholder_reader";
          -- Create tables
          CREATE TABLE axa.policy_holder (
            id text NOT NULL,
            "content" text NOT NULL,
            CONSTRAINT "pk_policy_holder" PRIMARY KEY (id)
          );

  metrics:
    auth:
      database: policy_act_policyholders
  migration_isolate: false
  backup:
    enabled: false
    cron:
      image:
        tag: 13-9
      schedule: "0 2 * * *" # 2am every day
      storageSize: 1Gi
      env:
        - name: DB_LOGIN
          value: svc_policy_act_policyholder_ci
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: password
        - name: FTP_LOGIN
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: ftp-login
        - name: FTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: ftp-password
        - name: PGPASSFILE
          value: /tmp/.pgpass
        - name: RETENTION_DAY
          value: "10"
    database:
      name: policy_act_policyholders

