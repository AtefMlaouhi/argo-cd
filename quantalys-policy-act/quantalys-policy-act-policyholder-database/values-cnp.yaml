postgresql:
  image:
    tag: 14.4.0-debian-11-r23
  primary:
    service:
      type: NodePort
    initdb:
      scripts:
        00.sql: |
          CREATE DATABASE policy_act_policyholders;

          -- CI
          CREATE ROLE "policy_act_policyholder_reader" WITH
            LOGIN
            NOSUPERUSER
            NOCREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD '1tiVMz1C';
          CREATE ROLE "svc_policy_act_policyholder" WITH
            LOGIN
            NOSUPERUSER
            NOCREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'DmS9Laqg';
          CREATE ROLE "svc_policy_act_policyholder_ci" WITH
            LOGIN
            NOSUPERUSER
            CREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'nWqgBOSj';
        01.sql: |
          \connect policy_act_policyholders
          -- Create Schema
          CREATE SCHEMA IF NOT EXISTS cnp;
          -- Default grants
          REVOKE CONNECT ON DATABASE policy_act_policyholders FROM PUBLIC;
          REVOKE ALL ON ALL TABLES IN SCHEMA public FROM PUBLIC;
          GRANT ALL ON DATABASE policy_act_policyholders TO postgres;
          -- PolicyHolder reader account
          GRANT CONNECT ON DATABASE policy_act_policyholders TO "policy_act_policyholder_reader";
          GRANT USAGE ON SCHEMA cnp TO "policy_act_policyholder_reader";
          GRANT SELECT ON ALL TABLES IN SCHEMA cnp TO "policy_act_policyholder_reader";
          ALTER DEFAULT PRIVILEGES IN SCHEMA cnp GRANT SELECT ON TABLES TO "policy_act_policyholder_reader";
          GRANT CONNECT ON DATABASE policy_act_policyholders TO "svc_policy_act_policyholder";
          -- PolicyHolder service account
          GRANT USAGE ON SCHEMA cnp TO "svc_policy_act_policyholder";
          GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA cnp TO "svc_policy_act_policyholder";
          GRANT USAGE,SELECT ON ALL SEQUENCES IN SCHEMA cnp to "svc_policy_act_policyholder";
          ALTER DEFAULT PRIVILEGES IN SCHEMA cnp GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO "svc_policy_act_policyholder";
          ALTER DEFAULT PRIVILEGES IN SCHEMA cnp GRANT SELECT ON TABLES TO "policy_act_policyholder_reader";
          -- Create tables
          CREATE TABLE IF NOT EXISTS __EFMigrationsHistory (
              MigrationId character varying(150) NOT NULL,
              ProductVersion character varying(32) NOT NULL,
              CONSTRAINT PK___EFMigrationsHistory PRIMARY KEY (MigrationId)
          );

          CREATE TABLE cnp.UserTransaction (
              Id integer GENERATED BY DEFAULT AS IDENTITY,
              UserId varchar(50) NOT NULL,
              UserInsurerId varchar(50) NOT NULL,
              TransactionId varchar(50) NOT NULL,
              PolicyId varchar(50) NOT NULL,
              PolicyHolderId varchar(50) NOT NULL,
              IsFinished boolean NOT NULL DEFAULT FALSE,
              SignatureStatus varchar(25) NOT NULL,
              SignatureMode varchar(25) NOT NULL,
              SignatureType varchar(25) NOT NULL,
              CurrentStep varchar(25) NOT NULL,
              CreatedDate timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
              CreatedBy varchar(50) NOT NULL,
              UpdatedDate timestamp NULL,
              UpdatedBy varchar(50) NULL,
              CONSTRAINT PK_UserTransaction PRIMARY KEY (Id)
          );

          CREATE TABLE cnp.ContactDetails (
              Id integer GENERATED BY DEFAULT AS IDENTITY,
              PolicyId varchar(50) NOT NULL,
              PrincipalAddress varchar(200) NULL,
              PrincipalAddressZipCode varchar(200) NULL,
              PrincipalAddressCity varchar(100) NULL,
              PrincipalAddressCountry varchar(100) NULL,
              TaxAddress varchar(100) NULL,
              TaxAddressZipCode varchar(50) NULL,
              TaxAddressCity varchar(100) NULL,
              TaxAddressCountry varchar(100) NULL,
              IsPrincipalAddressTaxAddress boolean NOT NULL,
              IsFrenchTaxResident boolean NOT NULL,
              Nif varchar(100) NULL,
              Email varchar(150) NULL,
              MobilePhoneNumber varchar(60) NULL,
              CreatedDate timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
              CreatedBy varchar(50) NOT NULL,
              UpdatedDate timestamp NULL,
              UpdatedBy varchar(50) NULL,
              CONSTRAINT PK_ContactDetails PRIMARY KEY (Id),
              CONSTRAINT FK_ContactDetails_UserTransaction_Id FOREIGN KEY (Id) REFERENCES cnp.UserTransaction (Id) ON DELETE CASCADE
          );

          CREATE TABLE cnp.FamilyInfo (
              Id integer GENERATED BY DEFAULT AS IDENTITY,
              PolicyId varchar(50) NOT NULL,
              MaritalStatus varchar(60) NULL,
              MatrimonialAgreementType varchar(60) NULL,
              DependantChildren integer NULL,
              CreatedDate timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
              CreatedBy varchar(50) NOT NULL,
              UpdatedDate timestamp NULL,
              UpdatedBy varchar(50) NULL,
              CONSTRAINT PK_FamilyInfo PRIMARY KEY (Id),
              CONSTRAINT FK_FamilyInfo_UserTransaction_Id FOREIGN KEY (Id) REFERENCES cnp.UserTransaction (Id) ON DELETE CASCADE
          );

          CREATE TABLE cnp.FurtherInfo (
              Id integer GENERATED BY DEFAULT AS IDENTITY,
              PolicyId varchar(50) NOT NULL,
              IsPoliticallyExposed boolean NULL,
              IsAmericanCitizenOrTaxCitizen boolean NULL,
              CreatedDate timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
              CreatedBy varchar(50) NOT NULL,
              UpdatedDate timestamp NULL,
              UpdatedBy varchar(50) NULL,
              CONSTRAINT PK_FurtherInfo PRIMARY KEY (Id),
              CONSTRAINT FK_FurtherInfo_UserTransaction_Id FOREIGN KEY (Id) REFERENCES cnp.UserTransaction (Id) ON DELETE CASCADE
          );

          CREATE TABLE cnp.Identity (
              Id integer GENERATED BY DEFAULT AS IDENTITY,
              PolicyId varchar(50) NOT NULL,
              IdType varchar(100) NULL,
              IdNumber varchar(50) NULL,
              IssuedBy varchar(100) NULL,
              IssuedDate varchar(50) NULL,
              ExpirationDate varchar(50) NULL,
              CreatedDate timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
              CreatedBy varchar(50) NOT NULL,
              UpdatedDate timestamp NULL,
              UpdatedBy varchar(50) NULL,
              CONSTRAINT PK_Identity PRIMARY KEY (Id),
              CONSTRAINT FK_Identity_UserTransaction_Id FOREIGN KEY (Id) REFERENCES cnp.UserTransaction (Id) ON DELETE CASCADE
          );

          CREATE TABLE cnp.Income (
              Id integer GENERATED BY DEFAULT AS IDENTITY,
              PolicyId varchar(50) NOT NULL,
              MonthlyIncome decimal NULL,
              AssetsNoRealEstate decimal NULL,
              CreatedDate timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
              CreatedBy varchar(50) NOT NULL,
              UpdatedDate timestamp NULL,
              UpdatedBy varchar(50) NULL,
              CONSTRAINT PK_Income PRIMARY KEY (Id),
              CONSTRAINT FK_Income_UserTransaction_Id FOREIGN KEY (Id) REFERENCES cnp.UserTransaction (Id) ON DELETE CASCADE
          );

          CREATE TABLE cnp.JobInfo (
              Id integer GENERATED BY DEFAULT AS IDENTITY,
              PolicyId varchar(50) NULL,
              ProfessionalSituation varchar(150) NULL,
              CSPTypeCode varchar(5) NOT NULL,
              ActivityArea varchar(150) NULL,
              Occupation varchar(150) NULL,
              PracticedSince timestamp NULL,
              CreatedDate timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
              CreatedBy varchar(50) NOT NULL,
              UpdatedDate timestamp NULL,
              UpdatedBy varchar(50) NULL,
              CONSTRAINT PK_JobInfo PRIMARY KEY (Id),
              CONSTRAINT FK_JobInfo_UserTransaction_Id FOREIGN KEY (Id) REFERENCES cnp.UserTransaction (Id) ON DELETE CASCADE
          );

          CREATE TABLE cnp.OriginalJSON (
              Id integer GENERATED BY DEFAULT AS IDENTITY,
              TransactionId varchar(50) NOT NULL,
              jsonb varchar(10000) NULL,
              CreatedDate timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'UTC'),
              CreatedBy varchar(50) NOT NULL,
              UpdatedDate timestamp NULL,
              UpdatedBy varchar(50) NULL,
              CONSTRAINT PK_OriginalJSON PRIMARY KEY (Id),
              CONSTRAINT FK_OriginalJSON_UserTransaction_Id FOREIGN KEY (Id) REFERENCES cnp.UserTransaction (Id) ON DELETE CASCADE
          );

          CREATE TABLE cnp.PersonalInfos (
              Id integer GENERATED BY DEFAULT AS IDENTITY,
              PolicyId varchar(50) NOT NULL,
              Role varchar(50) NULL,
              PersonId varchar(50) NULL,
              ExternalReference varchar(50) NULL,
              ClientNumber varchar(50) NULL,
              Title varchar(50) NULL,
              LegalForm varchar(60) NULL,
              BirthName varchar(100) NULL,
              LastName varchar(100) NOT NULL,
              FirstName varchar(100) NULL,
              SecondLastName varchar(100) NULL,
              ThirdFirstName varchar(100) NULL,
              BirthDate timestamp NULL,
              BirthZipCode varchar(50) NULL,
              InseeCityCode varchar(20) NULL,
              BirthCity varchar(100) NULL,
              BirthCountry varchar(100) NULL,
              Nationality varchar(60) NULL,
              SecondNationality varchar(60) NULL,
              LegalCapacity varchar(150) NULL,
              CreatedDate timestamp NULL DEFAULT TIMESTAMP '2023-09-21 10:32:54.13068',
              CreatedBy varchar(50) NOT NULL,
              UpdatedDate timestamp NULL,
              UpdatedBy varchar(50) NOT NULL,
              CONSTRAINT PK_PersonalInfos PRIMARY KEY (Id),
              CONSTRAINT FK_PersonalInfos_UserTransaction_Id FOREIGN KEY (Id) REFERENCES cnp.UserTransaction (Id) ON DELETE CASCADE
          );

          CREATE INDEX IX_ContactDetails_Email ON cnp.ContactDetails (Email);

          CREATE INDEX IX_ContactDetails_PolicyId ON cnp.ContactDetails (PolicyId);

          CREATE INDEX IX_FamilyInfo_PolicyId ON cnp.FamilyInfo (PolicyId);

          CREATE INDEX IX_FurtherInfo_PolicyId ON cnp.FurtherInfo (PolicyId);

          CREATE INDEX IX_Identity_IdNumber ON cnp.Identity (IdNumber);

          CREATE INDEX IX_Identity_PolicyId ON cnp.Identity (PolicyId);

          CREATE INDEX IX_Income_PolicyId ON cnp.Income (PolicyId);

          CREATE INDEX IX_JobInfo_PolicyId ON cnp.JobInfo (PolicyId);

          CREATE INDEX IX_OriginalJSON_TransactionId ON cnp.OriginalJSON (TransactionId);

          CREATE INDEX IX_PersonalInfos_ClientNumber ON cnp.PersonalInfos (ClientNumber);

          CREATE INDEX IX_PersonalInfos_LastName ON cnp.PersonalInfos (LastName);

          CREATE INDEX IX_PersonalInfos_PolicyId ON cnp.PersonalInfos (PolicyId);

          CREATE INDEX IX_UserTransaction_PolicyHolderId ON cnp.UserTransaction (PolicyHolderId);

          CREATE INDEX IX_UserTransaction_TransactionId ON cnp.UserTransaction (TransactionId);

          CREATE INDEX IX_UserTransaction_UserId_PolicyHolderId ON cnp.UserTransaction (UserId, PolicyHolderId);

          INSERT INTO __EFMigrationsHistory (MigrationId, ProductVersion)
          VALUES ('20230921083254_Initial', '6.0.20');


  metrics:
    auth:
      database: policy_act_policyholders
  migration_isolate: false
  backup:
    enabled: false
    cron:
      image:
        tag: 13-9
      schedule: "0 2 * * *" # 2am every day
      storageSize: 1Gi
      env:
        - name: DB_LOGIN
          value: svc_policy_act_policyholder_ci
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: password
        - name: FTP_LOGIN
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: ftp-login
        - name: FTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: ftp-password
        - name: PGPASSFILE
          value: /tmp/.pgpass
        - name: RETENTION_DAY
          value: "10"
    database:
      name: policy_act_policyholders

