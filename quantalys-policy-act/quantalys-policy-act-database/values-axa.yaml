postgresql:
  image:
    tag: 14.4.0-debian-11-r23

  primary:
    service:
      type: NodePort
    initdb:
      scripts:
        00.sql: |
          CREATE DATABASE policy_acts;

          -- CI
          CREATE ROLE "policy_act_reader" WITH
            LOGIN
            NOSUPERUSER
            NOCREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'YgNrgOFNXs';
          CREATE ROLE "svc_policy_act" WITH
            LOGIN
            NOSUPERUSER
            NOCREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'WPntyea1G1';
          CREATE ROLE "svc_policy_act_ci" WITH
            LOGIN
            NOSUPERUSER
            CREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'jJnYxAtA1H';
        01.sql: |
          \connect policy_acts
          -- Create Schema
          CREATE SCHEMA IF NOT EXISTS axa;
          -- Default grants
          REVOKE CONNECT ON DATABASE policy_acts FROM PUBLIC;
          REVOKE ALL ON ALL TABLES IN SCHEMA public FROM PUBLIC;
          GRANT ALL ON DATABASE policy_acts TO postgres;
          -- PolicyAct reader account
          GRANT CONNECT ON DATABASE policy_acts TO "policy_act_reader";
          GRANT USAGE ON SCHEMA axa TO "policy_act_reader";
          GRANT SELECT ON ALL TABLES IN SCHEMA axa TO "policy_act_reader";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT ON TABLES TO "policy_act_reader";
          GRANT CONNECT ON DATABASE policy_acts TO "svc_policy_act";
          -- PolicyAct service account
          GRANT USAGE ON SCHEMA axa TO "svc_policy_act";
          GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA axa TO "svc_policy_act";
          GRANT USAGE,SELECT ON ALL SEQUENCES IN SCHEMA axa to "svc_policy_act";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO "svc_policy_act";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT ON TABLES TO "policy_act_reader";
          -- Create tables
          CREATE TABLE axa.ActHolder (
              ActHolderId text NOT NULL,
              PolicyHolderId text NULL,
              PolicyId text NULL,
              Content text NULL,
              CONSTRAINT PK_ActHolder PRIMARY KEY (ActHolderId)
          );
          CREATE TABLE axa.Example (
              NumId int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE),
              Num varchar(3) NOT NULL,
              CodeA varchar(2) NOT NULL,
              MyInt int4 NOT NULL,
              CreationDate timestamp NOT NULL DEFAULT '2023-08-31 19:31:29.083761'::timestamp without time zone,
              CreatedBy varchar(30) NULL,
              LastModificationDate timestamp NOT NULL DEFAULT '2023-08-31 19:31:29.083788'::timestamp without time zone,
              ModifiedBy varchar(30) NULL,
              CONSTRAINT AK_Example_CodeA UNIQUE (CodeA),
              CONSTRAINT AK_Example_MyInt UNIQUE (MyInt),
              CONSTRAINT PK_Example PRIMARY KEY (NumId)
          );
          CREATE TABLE axa.SemiDigitalAct (
              Id int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE),
              ArbitrageDataId uuid NOT NULL,
              PolicyHolderId varchar(50) NOT NULL,
              PolicyId varchar(50) NOT NULL,
              InsurerCode varchar(50) NOT NULL,
              ShiftType varchar(50) NOT NULL,
              CreatedAt timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
              LastModified timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
              CreatedBy varchar(50) NOT NULL,
              LastModifiedBy varchar(50) NOT NULL,
              Content text NULL,
              CONSTRAINT PK_SemiDigitalAct PRIMARY KEY (Id)
          );
          CREATE TABLE axa.user_table (
              user_id int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE),
              user_name varchar(60) NOT NULL,
              user_password varchar(100) NOT NULL,
              email varchar(122) NOT NULL,
              user_role varchar(50) NOT NULL,
              refresh_token varchar(512) NULL,
              refresh_token_expiry_time timestamp NOT NULL,
              creation_date timestamp NOT NULL DEFAULT '2023-08-31 19:31:29.08278'::timestamp without time zone,
              created_by varchar(30) NULL,
              last_modification_date timestamp NOT NULL DEFAULT '2023-08-31 19:31:29.082813'::timestamp without time zone,
              modified_by varchar(30) NULL,
              CONSTRAINT AK_user_table_email UNIQUE (email),
              CONSTRAINT AK_user_table_user_name UNIQUE (user_name),
              CONSTRAINT PK_user_table PRIMARY KEY (user_id)
          );
          CREATE TABLE axa.SemiDigitalActDocuments (
              Id int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE),
              DocumentId varchar(50) NOT NULL,
              ShiftId int4 NOT NULL,
              CONSTRAINT PK_SemiDigitalActDocuments PRIMARY KEY (Id),
              CONSTRAINT FK_SemiDigitalActDocuments_SemiDigitalAct_ShiftId FOREIGN KEY (ShiftId) REFERENCES axa.SemiDigitalAct(Id) ON DELETE CASCADE
          );
          CREATE INDEX IX_SemiDigitalActDocuments_ShiftId ON axa.SemiDigitalActDocuments USING btree (ShiftId);

  metrics:
    auth:
      database: policy_acts

  migration_isolate: false

  backup:
    enabled: false
    cron:
      image:
        tag: 13-9

      schedule: "0 2 * * *" # 2am every day
      storageSize: 1Gi

      env:
        - name: DB_LOGIN
          value: svc_policy_act_ci
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: password
        - name: FTP_LOGIN
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: ftp-login
        - name: FTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: ftp-password
        - name: PGPASSFILE
          value: /tmp/.pgpass
        - name: RETENTION_DAY
          value: "10"

    database:
      name: policy_acts

