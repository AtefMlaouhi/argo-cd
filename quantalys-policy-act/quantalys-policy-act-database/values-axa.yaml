postgresql:
  image:
    tag: 14.4.0-debian-11-r23

  primary:
    service:
      type: NodePort
    initdb:
      scripts:
        00.sql: |
          CREATE DATABASE policy_acts;

          -- CI
          CREATE ROLE "policy_act_reader" WITH
            LOGIN
            NOSUPERUSER
            NOCREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'YgNrgOFNXs';
          CREATE ROLE "svc_policy_act" WITH
            LOGIN
            NOSUPERUSER
            NOCREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'WPntyea1G1';
          CREATE ROLE "svc_policy_act_ci" WITH
            LOGIN
            NOSUPERUSER
            CREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'jJnYxAtA1H';
        01.sql: |
          \connect policy_acts
          -- Create Schema
          CREATE SCHEMA IF NOT EXISTS axa;
          -- Default grants
          REVOKE CONNECT ON DATABASE policy_acts FROM PUBLIC;
          REVOKE ALL ON ALL TABLES IN SCHEMA public FROM PUBLIC;
          GRANT ALL ON DATABASE policy_acts TO postgres;
          -- PolicyAct reader account
          GRANT CONNECT ON DATABASE policy_acts TO "policy_act_reader";
          GRANT USAGE ON SCHEMA axa TO "policy_act_reader";
          GRANT SELECT ON ALL TABLES IN SCHEMA axa TO "policy_act_reader";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT ON TABLES TO "policy_act_reader";
          GRANT CONNECT ON DATABASE policy_acts TO "svc_policy_act";
          -- PolicyAct service account
          GRANT USAGE ON SCHEMA axa TO "svc_policy_act";
          GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA axa TO "svc_policy_act";
          GRANT USAGE,SELECT ON ALL SEQUENCES IN SCHEMA axa to "svc_policy_act";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO "svc_policy_act";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT ON TABLES TO "policy_act_reader";
          -- Create tables
          CREATE TABLE axa.act_holder (
              act_holder_id text NOT NULL,
              policy_holder_id text NULL,
              policy_id text NULL,
              "content" text NULL
          );
          CREATE TABLE axa.semi_digital_act (
              id int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY( NO MINVALUE NO MAXVALUE NO CYCLE),
              arbitrage_data_id uuid NOT NULL,
              policy_holder_id varchar(50) NOT NULL,
              policy_id varchar(50) NOT NULL,
              insurer_code varchar(50) NOT NULL,
              shift_type varchar(50) NOT NULL,
              created_at timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
              last_modified timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP,
              created_by varchar(50) NOT NULL,
              last_modified_by varchar(50) NOT NULL,
              "content" text NULL
          );
          CREATE TABLE axa.semi_digital_act_documents (
              id int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY( NO MINVALUE NO MAXVALUE NO CYCLE),
              document_id varchar(50) NOT NULL,
              shift_id int4 NOT NULL
          );

  metrics:
    auth:
      database: policy_acts

  migration_isolate: false

  backup:
    enabled: false
    cron:
      image:
        tag: 13-9

      schedule: "0 2 * * *" # 2am every day
      storageSize: 1Gi

      env:
        - name: DB_LOGIN
          value: svc_policy_act_ci
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: password
        - name: FTP_LOGIN
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: ftp-login
        - name: FTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: ftp-password
        - name: PGPASSFILE
          value: /tmp/.pgpass
        - name: RETENTION_DAY
          value: "10"

    database:
      name: policy_acts

