postgresql:
  image:
    tag: 14.4.0-debian-11-r23

  primary:
    service:
      type: NodePort
    initdb:
      scripts:
        00.sql: |
          CREATE DATABASE policy_acts;

          -- CI
          CREATE ROLE "policy_act_reader" WITH
            LOGIN
            NOSUPERUSER
            NOCREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'YgNrgOFNXs';
          CREATE ROLE "svc_policy_act" WITH
            LOGIN
            NOSUPERUSER
            NOCREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'WPntyea1G1';
          CREATE ROLE "svc_policy_act_ci" WITH
            LOGIN
            NOSUPERUSER
            CREATEDB
            NOCREATEROLE
            INHERIT
            NOREPLICATION
            CONNECTION LIMIT -1
            PASSWORD 'jJnYxAtA1H';
        01.sql: |
          \connect policy_acts
          -- Create Schema
          CREATE SCHEMA IF NOT EXISTS axa;
          -- Default grants
          REVOKE CONNECT ON DATABASE policy_acts FROM PUBLIC;
          REVOKE ALL ON ALL TABLES IN SCHEMA public FROM PUBLIC;
          GRANT ALL ON DATABASE policy_acts TO postgres;
          -- PolicyAct reader account
          GRANT CONNECT ON DATABASE policy_acts TO "policy_act_reader";
          GRANT USAGE ON SCHEMA axa TO "policy_act_reader";
          GRANT SELECT ON ALL TABLES IN SCHEMA axa TO "policy_act_reader";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT ON TABLES TO "policy_act_reader";
          GRANT CONNECT ON DATABASE policy_acts TO "svc_policy_act";
          -- PolicyAct service account
          GRANT USAGE ON SCHEMA axa TO "svc_policy_act";
          GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA axa TO "svc_policy_act";
          GRANT USAGE,SELECT ON ALL SEQUENCES IN SCHEMA axa to "svc_policy_act";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO "svc_policy_act";
          ALTER DEFAULT PRIVILEGES IN SCHEMA axa GRANT SELECT ON TABLES TO "policy_act_reader";
          -- Create tables
          CREATE TABLE IF NOT EXISTS __EFMigrationsHistory (
              migration_id character varying(150) NOT NULL,
              product_version character varying(32) NOT NULL,
              CONSTRAINT pk___ef_migrations_history PRIMARY KEY (migration_id)
          );
          CREATE TABLE axa.act_holder (
              act_holder_id text NOT NULL,
              policy_holder_id text NULL,
              policy_id text NULL,
              content text NULL,
              CONSTRAINT pk_act_holder PRIMARY KEY (act_holder_id)
          );
          CREATE TABLE axa.semi_digital_act (
              id integer GENERATED BY DEFAULT AS IDENTITY,
              arbitrage_data_id uuid NOT NULL,
              policy_holder_id VARCHAR(50) NOT NULL,
              policy_id VARCHAR(50) NOT NULL,
              insurer_code VARCHAR(50) NOT NULL,
              shift_type VARCHAR(50) NOT NULL,
              created_at timestamp with time zone NOT NULL DEFAULT (CURRENT_TIMESTAMP),
              last_modified timestamp with time zone NOT NULL DEFAULT (CURRENT_TIMESTAMP),
              created_by VARCHAR(50) NOT NULL,
              last_modified_by VARCHAR(50) NOT NULL,
              content text NULL,
              CONSTRAINT pk_semi_digital_act PRIMARY KEY (id)
          );
          CREATE TABLE axa.shift_tracker (
              id integer GENERATED BY DEFAULT AS IDENTITY,
              user_id VARCHAR(50) NOT NULL,
              insurer_code VARCHAR(50) NOT NULL,
              policy_holder_id VARCHAR(50) NOT NULL,
              policy_id VARCHAR(50) NOT NULL,
              shift_id VARCHAR(50) NOT NULL,
              divestment_type VARCHAR(50) NOT NULL,
              signature_status VARCHAR(50) NOT NULL,
              signature_mode VARCHAR(50) NOT NULL,
              signature_type VARCHAR(50) NOT NULL,
              signature_id VARCHAR(50) NULL,
              current_step VARCHAR(50) NOT NULL,
              is_submitted BOOL NOT NULL,
              created_at timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'Europe/Paris'),
              last_modified timestamp NOT NULL,
              created_by VARCHAR(50) NOT NULL,
              last_modified_by VARCHAR(50) NOT NULL,
              CONSTRAINT pk_shift_tracker PRIMARY KEY (id)
          );
          CREATE TABLE axa.semi_digital_act_documents (
              id integer GENERATED BY DEFAULT AS IDENTITY,
              document_id VARCHAR(50) NOT NULL,
              shift_id integer NOT NULL,
              CONSTRAINT pk_semi_digital_act_documents PRIMARY KEY (id),
              CONSTRAINT fk_semi_digital_act_documents_semi_digital_act_semi_digital_ac FOREIGN KEY (shift_id) REFERENCES axa.semi_digital_act (id) ON DELETE CASCADE
          );
          CREATE TABLE axa.divestment (
              id integer GENERATED BY DEFAULT AS IDENTITY,
              shift_data_id integer NOT NULL,
              code VARCHAR(50) NOT NULL,
              name VARCHAR(50) NULL,
              investment_managment_mode VARCHAR(50) NOT NULL,
              held_amount decimal NOT NULL,
              divestment_amount decimal NOT NULL,
              divestment_percentage decimal NOT NULL,
              created_at timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'Europe/Paris'),
              last_modified timestamp NOT NULL,
              created_by VARCHAR(50) NOT NULL,
              last_modified_by VARCHAR(50) NOT NULL,
              CONSTRAINT pk_divestment PRIMARY KEY (id),
              CONSTRAINT fk_divestment_shift_tracker_shift_tracker_data_id FOREIGN KEY (shift_data_id) REFERENCES axa.shift_tracker (id) ON DELETE CASCADE
          );
          CREATE TABLE axa.investment (
              id integer GENERATED BY DEFAULT AS IDENTITY,
              shift_data_id integer NOT NULL,
              code VARCHAR(50) NOT NULL,
              name VARCHAR(50) NULL,
              investment_managment_mode VARCHAR(50) NOT NULL,
              held_amount VARCHAR(50) NOT NULL,
              investment_percentage decimal NOT NULL,
              created_at timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'Europe/Paris'),
              last_modified timestamp NOT NULL,
              created_by VARCHAR(50) NOT NULL,
              last_modified_by VARCHAR(50) NOT NULL,
              CONSTRAINT pk_investment PRIMARY KEY (id),
              CONSTRAINT fk_investment_shift_tracker_shift_tracker_data_id FOREIGN KEY (shift_data_id) REFERENCES axa.shift_tracker (id) ON DELETE CASCADE
          );
          CREATE TABLE axa.shift_additional_infos (
              id integer GENERATED BY DEFAULT AS IDENTITY,
              shift_data_id integer NOT NULL,
              city VARCHAR(50) NULL,
              date_additional_info VARCHAR(200) NULL,
              observations VARCHAR(50) NULL,
              attestation1 BOOL NOT NULL,
              attestation2 BOOL NOT NULL,
              created_at timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'Europe/Paris'),
              last_modified timestamp NOT NULL,
              created_by VARCHAR(50) NOT NULL,
              last_modified_by VARCHAR(50) NOT NULL,
              CONSTRAINT pk_shift_additional_infos PRIMARY KEY (id),
              CONSTRAINT fk_shift_additional_infos_shift_tracker_shift_tracker_data_id FOREIGN KEY (shift_data_id) REFERENCES axa.shift_tracker (id) ON DELETE CASCADE
          );
          CREATE TABLE axa.shift_fees (
              id integer GENERATED BY DEFAULT AS IDENTITY,
              shift_data_id integer NOT NULL,
              shift_fees_total decimal NOT NULL,
              total_amount_divested decimal NOT NULL,
              total_amount_invested decimal NOT NULL,
              shift_fees_percentage decimal NOT NULL,
              created_at timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'Europe/Paris'),
              last_modified timestamp NOT NULL,
              created_by VARCHAR(50) NOT NULL,
              last_modified_by VARCHAR(50) NOT NULL,
              CONSTRAINT pk_shift_fees PRIMARY KEY (id),
              CONSTRAINT fk_shift_fees_shift_tracker_shift_tracker_data_id FOREIGN KEY (shift_data_id) REFERENCES axa.shift_tracker (id) ON DELETE CASCADE
          );
          CREATE TABLE axa.shift_sign_documents (
              id integer GENERATED BY DEFAULT AS IDENTITY,
              shift_data_id integer NOT NULL,
              document_id VARCHAR(200) NOT NULL,
              created_at timestamp NOT NULL DEFAULT (CURRENT_TIMESTAMP AT TIME ZONE 'Europe/Paris'),
              last_modified timestamp NOT NULL,
              created_by VARCHAR(50) NOT NULL,
              last_modified_by VARCHAR(50) NOT NULL,
              CONSTRAINT pk_shift_sign_documents PRIMARY KEY (id),
              CONSTRAINT fk_shift_sign_documents_shift_tracker_shift_tracker_data_id FOREIGN KEY (shift_data_id) REFERENCES axa.shift_tracker (id) ON DELETE CASCADE
          );
          CREATE INDEX ix_divestment_shift_data_id ON axa.divestment (shift_data_id);
          CREATE INDEX ix_investment_shift_data_id ON axa.investment (shift_data_id);
          CREATE INDEX ix_semi_digital_act_documents_shift_id ON axa.semi_digital_act_documents (shift_id);
          CREATE UNIQUE INDEX ix_shift_additional_infos_shift_data_id ON axa.shift_additional_infos (shift_data_id);
          CREATE UNIQUE INDEX ix_shift_fees_shift_data_id ON axa.shift_fees (shift_data_id);
          CREATE INDEX ix_shift_sign_documents_shift_data_id ON axa.shift_sign_documents (shift_data_id);

          ALTER TABLE axa.shift_tracker ALTER COLUMN user_id DROP NOT NULL;
          ALTER TABLE axa.shift_tracker ALTER COLUMN policy_holder_id DROP NOT NULL;
          ALTER TABLE axa.shift_tracker ALTER COLUMN last_modified_by DROP NOT NULL;
          ALTER TABLE axa.shift_tracker ALTER COLUMN created_by DROP NOT NULL;
          ALTER TABLE axa.shift_sign_documents ALTER COLUMN last_modified_by DROP NOT NULL;
          ALTER TABLE axa.shift_sign_documents ALTER COLUMN created_by DROP NOT NULL;
          ALTER TABLE axa.shift_fees ALTER COLUMN last_modified_by DROP NOT NULL;
          ALTER TABLE axa.shift_fees ALTER COLUMN created_by DROP NOT NULL;
          ALTER TABLE axa.shift_additional_infos ALTER COLUMN last_modified_by DROP NOT NULL;
          ALTER TABLE axa.shift_additional_infos ALTER COLUMN created_by DROP NOT NULL;
          ALTER TABLE axa.investment ALTER COLUMN last_modified_by DROP NOT NULL;
          ALTER TABLE axa.investment ALTER COLUMN created_by DROP NOT NULL;
          ALTER TABLE axa.divestment ALTER COLUMN last_modified_by DROP NOT NULL;
          ALTER TABLE axa.divestment ALTER COLUMN created_by DROP NOT NULL;     

  metrics:
    auth:
      database: policy_acts

  migration_isolate: false

  backup:
    enabled: false
    cron:
      image:
        tag: 13-9

      schedule: "0 2 * * *" # 2am every day
      storageSize: 1Gi

      env:
        - name: DB_LOGIN
          value: svc_policy_act_ci
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: password
        - name: FTP_LOGIN
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: ftp-login
        - name: FTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-backup
              key: ftp-password
        - name: PGPASSFILE
          value: /tmp/.pgpass
        - name: RETENTION_DAY
          value: "10"

    database:
      name: policy_acts

